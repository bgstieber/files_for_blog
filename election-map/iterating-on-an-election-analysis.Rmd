---
title: "Iterating on an Election Analysis"
author: "Brad Stieber"
date: "September 3, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE,
                      error = FALSE)
```

Jake Low wrote a [really interesting piece](https://beta.observablehq.com/@jake-low/how-well-does-population-density-predict-u-s-voting-outcome) that presented a few data visualizations that went beyond the typical [2016 election maps](https://www.nytimes.com/interactive/2018/upshot/election-2016-voting-precinct-maps.html) we've all gotten used to seeing. 

I liked a lot of things about Jake's posts, here are three I was particularly fond of:

  - His color palette choices
      - Each color palette that was used had solid perceptual properties and made sense for the data being visualized (i.e. diverging versus sequential)
  - He made residuals from a model interesting by visualizing _and_ interpretting them
  - He explained the usage of a log-scale transformation in an intuitive way, putting it in terms of the data set being used for the analysis.
      - This can be something data scientists and analysts struggle with

```{r}
library(tidyverse)
library(tidycensus)
library(ggmap)
library(scales)
library(maps)
```

In this post, I'm going to replicate Jake's analysis and then extend it a bit, by fitting a model which is a little more complicated than the one is his post.

In Jake's post, he used d3.js to do most of the work. As usual, I'll be using `R`.

## Getting the Data

For this analysis, we'll need a few different data sets, all measured at the county level:

  - 2016 election results
  - Population density
  - Educational information (how many people over 25 have some college or associate's degree)
  - Median income

I got election results from [this GitHub repository](https://github.com/tonmcg/County_Level_Election_Results_12-16). I plan on making a few heatmaps with this data, so I'm only including information from the [contiguous United States](https://en.wikipedia.org/wiki/Contiguous_United_States). There's also an issue I don't fully understand with Alaska vote reporting, where it seems as though county-level reporting doesn't exist.

```{r}
github_raw <- "https://raw.githubusercontent.com/"
repo <- "tonmcg/County_Level_Election_Results_12-16/master/"
data_file <- "2016_US_County_Level_Presidential_Results.csv"
results_16 <- read_csv(paste0(github_raw, repo, data_file)) %>%
  filter(! state_abbr %in% c('AK', 'HI')) %>%
  select(-X1) %>%
  mutate(total_votes = votes_dem + votes_gop,
         trump_ratio_clinton = 
           (votes_gop/total_votes) / (votes_dem/total_votes),
         two_party_ratio = (votes_dem) / (votes_dem + votes_gop)) %>%
  mutate(log_trump_ratio = log(trump_ratio_clinton)) 
```

To get some extra information about the counties I'll use the __`tidycensus`__(https://github.com/walkerke/tidycensus) package. For each county, I'm pulling information about the population over 25, the number of people over 25 with some college or associate's degree, and the median income.

```{r}
try_edu <- get_acs('county', 
                   c(pop_25 = 'B15003_001', 
                     edu = 'B16010_028', 
                     inc = 'B21004_001')) %>%
  select(-moe) %>%
  spread(variable, estimate)
```
 
Finally, I pulled in information about population density from the [Census American FactFinder](https://factfinder.census.gov/faces/tableservices/jsf/pages/productview.xhtml?src=bkmk). For aspiring data scientists, it's important to remember that if you _think_ the U.S. government collects a certain type of data, they probably do. It's also important to remember that the structure of the data will create such a headache that you'll start to question if it's even worth it. They've actually gotten a lot better, but I can remember times during undergrad when I spent _hours_ reshaping BLS data in Excel. 

Once I downloaded that data, I threw it into a [GitHub repo](https://github.com/bgstieber/files_for_blog/tree/master/election-map/Data).

```{r}
repo <- "bgstieber/files_for_blog/master/election-map/"
data_file <- "Data/pop_density_by_county.csv"
pop_density <- read_csv(paste0(github_raw, repo, data_file), skip = 1) %>%
  mutate(population = as.numeric(Population)) %>%
  select(geography = `Geographic area`,
         FIPS = `Target Geo Id2`,
         population,
         'population_density' = `Density per square mile of land area - Population`)
```

## Recreating Jake's Analysis

First, we're going to make the 2016 election map.

```{r}
special_fips <- c(12091L, 22099L, 37053L, 48167L, 51001L, 
                  53053L, 53055L)
county_map_with_fips <- county.fips %>% 
    separate(polyname, c('region', 'subregion'), ',') %>%
    mutate(subregion = ifelse(fips %in% special_fips,
                              stringi::stri_split_fixed(subregion,
                                                        ":",
                                                        n=1,
                                                        tokens_only = TRUE) %>%
                                unlist,
                              subregion)) %>%
    unique() %>%
    inner_join(map_data('county'))

election_results <- county_map_with_fips %>%
    inner_join(select(results_16, combined_fips, state_abbr, 
                      county_name, log_trump_ratio, two_party_ratio),
               by = c('fips' = 'combined_fips'))

```

We'll be making the map using `ggplot2`. You might notice some funky stuff going on with `scale_fill_gradientn`. To make the map more visually salient, I've played around a bit with scaling the colors.


```{r fig.width = 8, fig.height=6}
map_labels <- c('1:16', '1:3', '1:1', '3:1', '16:1')

election_results %>%
    ggplot(aes(x = long, y = lat, group = group,
               fill = log_trump_ratio))+
    geom_polygon(colour = rgb(0.9,0.9,0.9, .1))+
    geom_polygon(data = map_data('state'), fill = NA, colour = 'white')+
    scale_fill_gradientn(values = rescale(c(-3, -1, 0, 1, 3)),
                         colors = rev(brewer_pal(palette = 'RdBu')(5)),
                         labels = map_labels,
                         breaks = log(c(1/16, 1/3, 1, 3/1, 16/1)),
                         name = 'Trump : Clinton Ratio')+
    theme_minimal()+
    theme(axis.text = element_blank(),
          panel.grid = element_blank(),
          legend.position = 'top')+
    coord_map()+
    xlab('')+ylab('')+
    guides(fill = guide_colorbar(barwidth = 10, 
                                 barheight = 1,
                                 direction = 'horizontal'))
```

Then we'll take a look at population density:

```{r fig.width=8, fig.height=6}
county_map_with_fips %>%
    inner_join(pop_density, by = c('fips' = 'FIPS')) %>%
    ggplot(aes(long, lat, group = group, fill = population_density))+
    geom_polygon(colour = rgb(0.9,0.9,0.9, .1))+
    geom_polygon(data = map_data('state'), fill = NA, colour = 'white')+
    scale_fill_viridis_c(trans = log_trans(2),option = 'magma',
                         name = 'Population Density per Square Mile')+
      theme_minimal()+
      theme(axis.text = element_blank(),
            panel.grid = element_blank(),
            legend.position = 'top')+
      coord_map()+
      xlab('')+ylab('')+
      guides(fill = guide_colorbar(barwidth = 10, 
                                   barheight = 1,
                                   direction = 'horizontal'))
```

Finally, we're going to try to predict the 2016 election results using population density. 

First, let's examine a scatter plot of the data.

```{r}
results_and_pop_density <- results_16 %>% 
  inner_join(pop_density, by = c('combined_fips' = 'FIPS')) %>%
  mutate(two_party_ratio = (votes_dem) / (votes_dem + votes_gop))

results_and_pop_density %>%
    ggplot(aes(population_density, two_party_ratio))+
    geom_point(aes(size = population),
               shape = 21, colour = 'dodgerblue3')+
    scale_x_continuous(trans = log_trans(2),
                       name = 'Population Density per Square Mile')+
    scale_size_continuous(trans = sqrt_trans())+
    ylab('Two Party Vote Ratio (> 0.5 favors Clinton, < 0.5 favors Trump)')
```


## Extending Jake's Analysis

