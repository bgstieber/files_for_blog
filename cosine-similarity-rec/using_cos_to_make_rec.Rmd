---
title: "Using Cosine Similarity to Make Recommendations in R"
author: "Brad Stieber"
date: "December 29, 2018"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

Recommendation engines impact a large amount of our online lives. The content we watch on Netflix, the products we purchase on Amazon, and even [the homes we buy](https://www.redfin.com/blog/2013/09/the-end-of-search.html) are all served up using recommendation engines. In this post, I'll run through one of the key metrics used in recommendation engines: the cosine similarity.

## Introduction

## The Math: Cosine Similarity

## The Code: Calculating Cosine Similarity in `R`

```{r}
cosine_sim <- function(x, y) crossprod(x,y)/sqrt(crossprod(x)*crossprod(y))
```


## The Data: Recommending Songs

We use data from the [Million Song Dataset](https://labrosa.ee.columbia.edu/millionsong/). We're working with a subset of the data (only 10K songs), but that should be enough for us.

```{r echo = TRUE}
library(tidyverse)

play_data <- "https://static.turi.com/datasets/millionsong/10000.txt" %>%
  read_tsv(col_names = c('user', 'song_id', 'plays'))

song_data <- 'https://static.turi.com/datasets/millionsong/song_data.csv' %>%
  read_csv() %>%
  distinct(song_id, title, artist_name)

users <- play_data %>%
  distinct(user)

all_data <- play_data %>%
  group_by(user, song_id) %>%
  summarise(plays = sum(plays, na.rm = TRUE)) %>%
  inner_join(song_data)
```

Here are the first few rows of the data:

```{r}
head(all_data)
```

Now, there happen to be a lot of users in this data set, so combining the number of users with songs makes the data a little too unwieldy for this toy example. We're going to filter our dataset so that it's only based on the top 1,000 songs.

```{r cache=TRUE}
top_1k_songs <- all_data %>%
    group_by(song_id, title, artist_name) %>%
    summarise(sum_plays = sum(plays)) %>%
    ungroup() %>%
    top_n(1000, sum_plays) %>% 
    distinct(song_id)

all_data_top_1k <- all_data %>%
  inner_join(top_1k_songs)

top_1k_wide <- all_data_top_1k %>%
    ungroup() %>%
    distinct(user, song_id, plays) %>%
    spread(song_id, plays, fill = 0)

ratings <- as.matrix(top_1k_wide[,-1])

```

```{r}
calc_cos_sim <- function(song_code, 
                         rating_mat = ratings,
                         songs = song_data){
  
  song_col_index <- which(colnames(rating_mat) == song_code)
  
  cos_sims <- apply(rating_mat, 2,
                    FUN = function(y) cosine_sim(rating_mat[,song_col_index],
                                                 y))
  
  data_frame(song_id = names(cos_sims),
             cos_sim = cos_sims) %>%
    filter(song_id != song_code) %>% # remove self reference
    inner_join(songs) %>%
    arrange(desc(cos_sim))
  
}
```

We can use the function above to calculate similarities for a few songs.

```{r}
forgot_about_dre <- 'SOPJLFV12A6701C797'

enter_sandman <- 'SOCHYVZ12A6D4F5908'

come_as_you_are <- 'SODEOCO12A6701E922'
```



## Conclusion

Links:

- [Wikipedia: Cosine Similarity](https://en.wikipedia.org/wiki/Cosine_similarity)
- [Machine Learning :: Cosine Similarity for Vector Space Models (Part III)](http://blog.christianperone.com/2013/09/machine-learning-cosine-similarity-for-vector-space-models-part-iii/)
- [Introduction to Collaborative Filtering](https://hackernoon.com/introduction-to-recommender-system-part-1-collaborative-filtering-singular-value-decomposition-44c9659c5e75)