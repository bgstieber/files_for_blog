---
title: "Using Data Science to Make a Christmas Playlist that Doesn't Suck"
author: "Brad Stieber"
date: "November 22, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
```

In this post, I'm going to using data from Spotify to make a Christmas playlist that you'll actually like. We're going to employ a few standard data science techniques to __import__ data, __explore__ it, and finally __model__ the data.

Here are the steps we're going to take

1. Pull data into `R` using the [__`spotifyr`__](https://www.rcharlie.com/spotifyr/) package
1. Clean up the data using functions from the [__`caret`__](http://caret.r-forge.r-project.org/) package
1. Use principal components analysis to reduce the dimensionality of our data
1. Apply k-nearest neighbor and logistic regression modeling techniques to find Christmas songs that don't suck
1. Use our findings to create a playlist that you won't feel like turning off after ten minutes

Here are the packages we'll need:

```{r}
library(spotifyr)
library(tidyverse)
library(scales)
library(caret)
library(ggrepel)
library(RANN)
theme_set(theme_bw())
```


## Getting data from Spotify

The `spotifyr` package makes it really easy to grab data from Spotify. You can find a pretty good tutorial to get up-and-running from the [package's website](https://www.rcharlie.com/spotifyr/).

In the code below, we're going to connect to Spotify, and then pull all of my playlists. I created two playlists for this analysis. The first is called __holiday_playlist__, and it's a collection of 21 songs that I thought were pretty good. Then, we're going to pull in another playlist called __spotify_holiday_playlists__, which is a collection of 300+ holiday songs coming from a variety of Spotify holiday playlists (you can find the list of playlists I used [on my GitHub](https://github.com/bgstieber/files_for_blog/blob/master/make-christmas-playlist/spotify_playlists.txt)).

```{r}
# connect
access_token <- get_spotify_access_token()
```

```{r cache = TRUE, results=FALSE}
# get my playlists
my_playlists <- get_user_playlists('12102534356') 
# get playlist and playlist track info
## my curated list
holiday_playlist <- my_playlists  %>%
  filter(playlist_name == 'holiday_playlist') %>%
  get_playlist_tracks()

holiday_playlist_features <- holiday_playlist %>%
  get_track_audio_features()

## collection of spotify songs
spotify_holiday <- my_playlists %>%
  filter(playlist_name == 'spotify_holiday_playlists') %>%
  get_playlist_tracks() %>%
  # filter duplicates
  filter(!duplicated(.[c('track_name', 'artist_name')] %>%
           mutate_all(toupper)))

spotify_holiday_features <- spotify_holiday %>%
  get_track_audio_features()
```

Now we have all the data we'll need for this analysis. We have four `data_frame`s to play with. There are two containing qualitative information about the tracks (`holiday_playlist` and `spotify_holiday`) and two containing quantitative information (`holiday_playlist_features` and `spotify_holiday_features)`. 

The quantitative information has variables like __energy__ (a measure of the intensity and activity of the track) and __danceability__ (describes how suitable a track is for dancing). More information can be found in [the documentation for the Spotify API](https://developer.spotify.com/documentation/web-api/reference/tracks/get-audio-features/).

## Data Processing

Let's take a look at the structure of `holiday_playlist_features`.

```{r}
str(holiday_playlist_features)
```

We can also visualize the quantitative variables. We'll look at both data sets, and the distributions should give us insight into whether we need to transform any of the variables (e.g. log-scale, square root transformations).

First, we'll look at the features from the playlist I hand-curated.

```{r echo = FALSE}
holiday_playlist_features %>%
  select_if(is.numeric) %>%
  gather(variable, value) %>%
  ggplot(aes(value, fill = variable))+
  geom_histogram()+
  facet_wrap(~variable, scales = 'free')+
  theme(legend.position = 'none')+
  ggtitle('Hand Curated Playlist Features',
          subtitle = "These songs don't suck")
```

Then we'll look at the playlist with candidate songs to be added to the Playlist that Doesn't Suck.

```{r echo = FALSE}
spotify_holiday_features %>%
  select_if(is.numeric) %>%
  gather(variable, value) %>%
  ggplot(aes(value, fill = variable))+
  geom_histogram()+
  facet_wrap(~variable, scales = 'free')+
  theme(legend.position = 'none')+
  ggtitle('Candidate Playlist Features',
          subtitle = "These songs might suck")
```


## Dimensionality Reduction with PCA

## Models

## Combining our Intelligence

## "Wrapping" Up

